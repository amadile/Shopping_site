name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://shoppingsite.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci --production

      - name: Run full test suite
        working-directory: ./backend
        run: npm test -- --coverage
        env:
          NODE_ENV: test
          MONGO_URI: ${{ secrets.TEST_MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Verify test coverage
        working-directory: ./backend
        run: |
          COVERAGE=$(node -e "const fs = require('fs'); const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json')); console.log(coverage.total.lines.pct);")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "Coverage below 70%, blocking deployment"
            exit 1
          fi

      - name: Security audit
        working-directory: ./backend
        run: npm audit --audit-level=high

      - name: Build application
        working-directory: ./backend
        run: |
          echo "Building production application..."
          npm run build || echo "No build script defined"

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r backend/src deploy/
          cp -r backend/node_modules deploy/
          cp backend/package*.json deploy/
          cp backend/.env.production deploy/.env || true
          tar -czf deploy.tar.gz deploy/

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: deploy.tar.gz
          retention-days: 30

      - name: Configure AWS credentials
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload to S3
        continue-on-error: true
        run: |
          aws s3 cp deploy.tar.gz s3://${{ secrets.S3_BUCKET }}/releases/${{ github.sha }}.tar.gz

      - name: Deploy to AWS Elastic Beanstalk
        continue-on-error: true
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name shopping-site \
            --version-label ${{ github.sha }} \
            --source-bundle S3Bucket="${{ secrets.S3_BUCKET }}",S3Key="releases/${{ github.sha }}.tar.gz"

          aws elasticbeanstalk update-environment \
            --application-name shopping-site \
            --environment-name shopping-site-production \
            --version-label ${{ github.sha }}

      - name: Wait for deployment
        continue-on-error: true
        run: |
          echo "Waiting for deployment to complete..."
          sleep 120

      - name: Deploy to Azure App Service
        continue-on-error: true
        uses: azure/webapps-deploy@v3
        with:
          app-name: "shopping-site-prod"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy.tar.gz

      - name: Deploy to Heroku
        continue-on-error: true
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "shopping-site-prod"
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: backend

      - name: Deploy via SSH
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/shopping-site
            git pull origin main
            npm ci --production
            npm run migrate || echo "No migrations"
            pm2 restart shopping-site --update-env

      - name: Run smoke tests
        run: |
          sleep 60
          echo "Running production smoke tests..."
          curl -f https://shoppingsite.com/health || exit 1
          curl -f https://shoppingsite.com/api/products || exit 1

      - name: Run end-to-end tests
        run: |
          echo "Running E2E tests against production..."
          # Add E2E test commands here

      - name: Monitor deployment
        run: |
          echo "Monitoring deployment for 5 minutes..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://shoppingsite.com/health)
            if [ $STATUS -eq 200 ]; then
              echo "Health check passed ($i/10)"
            else
              echo "Health check failed with status $STATUS"
              exit 1
            fi
            sleep 30
          done

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Production deployment for ${{ github.ref_name }}

            **Changes:**
            ${{ github.event.head_commit.message }}

            **Deployment Time:** ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        with:
          status: custom
          custom_payload: |
            {
              text: 'ðŸš€ Production deployment successful!',
              attachments: [{
                color: 'good',
                fields: [{
                  title: 'Commit',
                  value: '${{ github.sha }}',
                  short: true
                }, {
                  title: 'Branch',
                  value: '${{ github.ref }}',
                  short: true
                }, {
                  title: 'Author',
                  value: '${{ github.actor }}',
                  short: true
                }, {
                  title: 'Deployment URL',
                  value: 'https://shoppingsite.com',
                  short: true
                }]
              }]
            }

      - name: Notify deployment failure
        if: failure()
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        with:
          status: custom
          custom_payload: |
            {
              text: 'âŒ Production deployment failed!',
              attachments: [{
                color: 'danger',
                fields: [{
                  title: 'Commit',
                  value: '${{ github.sha }}',
                  short: true
                }, {
                  title: 'Branch',
                  value: '${{ github.ref }}',
                  short: true
                }, {
                  title: 'Author',
                  value: '${{ github.actor }}',
                  short: true
                }, {
                  title: 'Workflow',
                  value: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                  short: false
                }]
              }]
            }

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          # Add rollback commands here

      - name: Record deployment
        if: always()
        run: |
          echo "Deployment $(date): Status ${{ job.status }}" >> deployments.log
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add deployments.log || true
          git commit -m "Record production deployment: ${{ job.status }}" || true
          git push || true
